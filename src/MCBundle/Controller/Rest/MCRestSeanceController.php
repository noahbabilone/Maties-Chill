<?php/** * Created by PhpStorm. * User: Yann * Date: 21/02/2016 * Time: 17:25 */namespace MCBundle\Controller\Rest;use FOS\RestBundle\FOSRestBundle;use FOS\RestBundle\View\View as FOSView;use MCBundle\Controller\FilmController;use MCBundle\Entity\Material;use MCBundle\Entity\Seance;use MCBundle\Entity\Address;use MCBundle\Entity\Modality;use Symfony\Bundle\FrameworkBundle\Controller\Controller;use FOS\RestBundle\Controller\Annotations\View;use FOS\RestBundle\Controller\Annotations\Get;use FOS\RestBundle\Controller\Annotations\Delete;use FOS\RestBundle\Controller\Annotations\Put;use FOS\RestBundle\Controller\Annotations\Post;use Nelmio\ApiDocBundle\Annotation\ApiDoc;use Sensio\Bundle\FrameworkExtraBundle\Configuration\ParamConverter;use FOS\RestBundle\Controller\Annotations\RequestParam;use FOS\RestBundle\Request\ParamFetcher;use Symfony\Component\Validator\ConstraintViolationList;class MCRestSeanceController extends Controller{    /**     * @ApiDoc(     *   resource = true,     *   description = "Return the overall Seances List",     *   statusCodes = {     *     200 = "Returned when successful",     *     404 = "Returned when the user is not found"     *   }     * )     * @return View     */    public function getSeancesAction()    {        $em = $this->getDoctrine()->getManager();        $seances = $em->getRepository('MCBundle:Seance')->findAll();        if (!$seances) {            throw $this->createNotFoundException('Data not found.');        }        $view = FOSView::create();        $view->setData($seances)->setStatusCode(200);        return $view;    }    /**     * Get a Seance.     * @ApiDoc(     *   resource = true,     *   description = "Return an Seance identified by ID",     *   statusCodes = {     *     200 = "Returned when successful",     *     404 = "Returned when the user is not found"     *   }     * ) * Get a User.     * @param Seance $seance     * @return array     * @View()     * @ParamConverter("seance", class="MCBundle:Seance")     */    public function getSeanceAction(Seance $seance)    {        return $seance;    }    /**     * * Delete an Seance identified by ID.     * @ApiDoc(     *   resource = true,     *   description = "Delete an seance identified by ID",     *   statusCodes = {     *     200 = "Returned when successful",     *     404 = "Returned when the user is not found"     *   }     * )     * Removes a Seance.     * @Delete("/seances/delete/{id}")     * @param int $id the Seance id     * @return View     */    public function deleteSeanceAction($id)    {        $em = $this->getDoctrine()->getManager();        $seance = $em->getRepository('MCBundle:Seance')->find($id);        $em->remove($seance);        $em->flush();        $result = $em->getRepository('MCBundle:Seance')->find($id);        $view = FOSView::create();        if (null == $result) {            $view->setData('Seance deleted')->setStatusCode(200);        } else {            $view->setData('Seance don\'t delete')->setStatusCode(404);        }        return $view;    }    /**     * Get all Seances by ID Film     * @ApiDoc(     *   resource = true,     *   description = "Get all Seances by ID Film",     *   statusCodes = {     *     200 = "Returned when successful",     *     404 = "Returned when the user is not found"     *   }     * )     * @Get("/seances/film/{idFilm}")     * @param $idFilm     * @return View     */    public function getSeanceFilmAction($idFilm)    {        $em = $this->getDoctrine()->getManager();        $seances = $em->getRepository('MCBundle:Seance')->findByFilm($idFilm);        $view = FOSView::create();        if ($seances) {            $view->setData($seances)->setStatusCode(200);        } else {            $view->setData($seances)->setStatusCode(404);        }        return $view;    }    /**     * Get all Seances of ID User     * @ApiDoc(     *   resource = true,     *   description = "Return all Seances of User",     *   statusCodes = {     *     200 = "Returned when successful",     *     404 = "Returned when the user is not found"     *   }     * )     * @Get("/seances/user/{idUser}")     * @param $idUser     * @return View     */    public function getSeanceUserAction($idUser)    {        $em = $this->getDoctrine()->getManager();        $seances = $em->getRepository('MCBundle:Seance')->findByCreator($idUser);        $view = FOSView::create();        if ($seances) {            $view->setData($seances)->setStatusCode(200);        } else {            $view->setData($seances)->setStatusCode(404);        }        return $view;    }    /**     * Create a seance from the submitted data.<br/>     * @ApiDoc(     *   resource = true,     *   description = "Create a new seance from the submitted data.",     *   statusCodes = {     *     200 = "Returned when successful",     *     400 = "Returned when the form has errors"     *   }     * )     * @param ParamFetcher $paramFetcher Paramfetcher     *     * @RequestParam(name="idUser", nullable=false, strict=true, description="id de l'utilisateur.")     * @RequestParam(name="date", nullable=false, strict=true, description="Date de la séance.")     * @RequestParam(name="typeView", nullable=false, strict=true, description="Type de visionnage.")     * @RequestParam(name="description", nullable=false, strict=true, description="Description de l'annonce.")     * @RequestParam(name="contribution", nullable=false, strict=true, description="Contribution.")     * @RequestParam(name="price", nullable=false, strict=true, description="Prix.")     * @RequestParam(name="idAddress", nullable=false, strict=true, description="Id Adresse de l'utilisateur.")     * @RequestParam(name="maxPlace", nullable=false, strict=true, description="ID de l'adresse.")     * @RequestParam(name="idModality", nullable=false, strict=true, description="ID modalité.")     * @RequestParam(name="ISAN", nullable=false, strict=true, description="Code du film.")     *     * @return View     */    public function postSeancesAction(ParamFetcher $paramFetcher)    {        $em = $this->getDoctrine()->getManager();        $objSeance = new Seance();        $user = $em->getRepository('UserBundle:User')->find($paramFetcher->get('idUser'));        $objSeance->setCreator($user);        $objSeance->setDate(new \DateTime ($paramFetcher->get('date')));        $objSeance->setTypeView($paramFetcher->get('typeView'));        $objSeance->setDescription($paramFetcher->get('description'));        $objSeance->setContribution($paramFetcher->get('contribution'));        $objSeance->setPrice($paramFetcher->get('price'));        $objSeance->setMaxPlace($paramFetcher->get('maxPlace'));        if ($paramFetcher->get('idAddress')) {            $address = $em->getRepository('MCBundle:Address')->find($paramFetcher->get('idAddress'));            $objSeance->setAddress($address);        }        $modality = $em->getRepository('MCBundle:Modality')->find($paramFetcher->get('idModality'));        $objSeance->setModality($modality);        $film = $em->getRepository('MCBundle:Film')->findOneBy(array("ISAN" => $paramFetcher->get('ISAN')));        if (!$film) {            $allocine = $this->get("mc_allocine");            $result = $allocine->get($paramFetcher->get('ISAN'));            $data = json_decode($result);            $controllerFilm = new FilmController();            $film = $controllerFilm->parserMovie($data->movie);            $em->persist($film);            $em->flush();            $objSeance = $em->getRepository('MCBundle:Film')->find($film->getId());            if (!$film) {                throw $this->createNotFoundException('Error add film.');            }        }        $objSeance->setFilm($film);        $em->persist($objSeance);        $em->flush();        $objSeance = $em->getRepository('MCBundle:Seance')->find($objSeance->getId());        return $objSeance;    }    /**     * Update a seance from the submitted data.<br/>     * @ApiDoc(     *   resource = true,     *   description = "Update seance from the submitted data.",     *   statusCodes = {     *     200 = "Returned when successful",     *     400 = "Returned when the form has errors"     *   }     * )     * @param ParamFetcher $paramFetcher Paramfetcher     *     * @RequestParam(name="idUser", nullable=false, strict=true, description="id de l'utilisateur.")     * @RequestParam(name="date", nullable=false, strict=true, description="Date de la séance.")     * @RequestParam(name="typeView", nullable=false, strict=true, description="Type de visionnage.")     * @RequestParam(name="description", nullable=false, strict=true, description="Description de l'annonce.")5* @RequestParam(name="price", nullable=false, strict=true, description="Prix.")     * @RequestParam(name="idAddress", nullable=false, strict=true, description="Id de l'Adresse de l'utilisateur.")     * @RequestParam(name="maxPlace", nullable=false, strict=true, description="ID de l'adresse.")     * @RequestParam(name="idModalitly", nullable=false, strict=true, description="ID modalité.")     * @RequestParam(name="idFilm", nullable=false, strict=true, description="ID du film.")     *     * @return View     */    public function putSeanceAction(ParamFetcher $paramFetcher)    {        $em = $this->getDoctrine()->getManager();        $objSeance = $em->getRepository('MCBundle:Seance')->find($paramFetcher->get('id'));        if ($paramFetcher->get('date'))            $objSeance->setDate(new \DateTime ($paramFetcher->get('date')));        if ($paramFetcher->get('typeView'))            $objSeance->setTypeView($paramFetcher->get('typeView'));        if ($paramFetcher->get('description'))            $objSeance->setDescription($paramFetcher->get('description'));        if ($paramFetcher->get('contribution'))            $objSeance->setContribution($paramFetcher->get('contribution'));        if ($paramFetcher->get('price'))            $objSeance->setPrice($paramFetcher->get('price'));        if ($paramFetcher->get('maxPlace'))            $objSeance->setMaxPlace($paramFetcher->get('maxPlace'));        if ($paramFetcher->get('idAddress')) {            $address = $em->getRepository('MCBundle:Address')->find($paramFetcher->get('idAddress'));            $objSeance->setAddress($address);        }        if ($paramFetcher->get('idFilm')) {            $film = $em->getRepository('MCBundle:Film')->find($paramFetcher->get('idFilm'));            $objSeance->setFilm($film);        }        $em->flush();        return $objSeance;    }    /**     * Add Material Seance from the submitted data by ID.<br/>     * @ApiDoc(     *   resource = true,     *   description = "Add Material Seance from the submitted data by ID.",     *   statusCodes = {     *     200 = "Returned when successful",     *     400 = "Returned when the form has errors"     *   }     * )     * @Put("/seances/add-material")     * @param ParamFetcher $paramFetcher Paramfetcher     *     * @RequestParam(name="id", nullable=false, strict=true, description="id de la séance")     * @RequestParam(name="idMaterial", nullable=false, strict=true, description="id matiriel à ajouter.")     * @return View     */    public function putMaterialSeanceAction(ParamFetcher $paramFetcher)    {        $em = $this->getDoctrine()->getManager();        $seance = $em->getRepository('MCBundle:Seance')->find($paramFetcher->get('id'));        if ($paramFetcher->get('idMaterial')) {            $material = $em->getRepository('MCBundle:Material')->find($paramFetcher->get('idMaterial'));            $seance->addMaterial($material);        }        $view = FOSView::create();        $errors = $this->get('validator')->validate($seance, array('Update'));        if (count($errors) == 0) {            $em->flush();            $view->setData($seance)->setStatusCode(200);            return $view;        } else {            $view = $this->getErrorsView($errors);            return $view;        }    }    /**     * Add Participant Seance from the submitted data by ID.<br/>     * @ApiDoc(     *   resource = true,     *   description = "Add Material Seance from the submitted data by ID.",     *   statusCodes = {     *     200 = "Returned when successful",     *     400 = "Returned when the form has errors"     *   }     * )     * @Put("/seances/add-participant")     * @param ParamFetcher $paramFetcher Paramfetcher     *     * @RequestParam(name="id", nullable=false, strict=true, description="id de la séance")     * @RequestParam(name="idParticipant", nullable=false, strict=true, description="id Participant à ajouter.")     * @return View     */    public function putParticipantSeanceAction(ParamFetcher $paramFetcher)    {        $em = $this->getDoctrine()->getManager();        $seance = $em->getRepository('MCBundle:Seance')->find($paramFetcher->get('id'));        if ($paramFetcher->get('username')) {            $user = $em->getRepository('UserBundle:User')->find($paramFetcher->get('idParticipant'));            $seance->addParticipant($user);        }        $view = FOSView::create();        $errors = $this->get('validator')->validate($seance, array('Update'));        if (count($errors) == 0) {            $em->flush();            $view->setData($seance)->setStatusCode(200);            return $view;        } else {            $view = $this->getErrorsView($errors);            return $view;        }    }    /**     * @Get("/seances-isan/{i}")     * @View()     * @return string     */    public function testISANAction($i)    {        $em = $this->getDoctrine()->getManager();        $film = $em->getRepository('MCBundle:Film')->findOneBy(array("ISAN" => $i));        dump($film);        die;    }    /**     * @Get("/seances/{idSeance}/add/user/{idUser}")     * @View()     * @param $idSeance     * @param $idUser     * @return string     */    public function addParticipantSeanceAction($idSeance, $idUser)    {        $em = $this->getDoctrine()->getManager();        $seance = $em->getRepository('MCBundle:Seance')->find($idSeance);        if ($seance) {            $user = $em->getRepository('UserBundle:User')->find($idUser);            if ($user) {                if ($user->getId() !== $seance->getCreator()->getId()) {                    $seance->addParticipant($user);                    $em->flush();                    return $seance;                } else {                    return "Error: l'user is the creator";                }            } else {                return "Error: user don't exist for id : " . $idUser;            }        } else {            return "Error: Seance don't exist for id " . $idSeance;        }    }}